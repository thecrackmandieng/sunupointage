<app-sidebar></app-sidebar>

<div class="main-content">

    <div class="filter-section">
      <div class="action-button-container">
        <!-- Affichage du bouton Ajouter un Département si on est sur la page des départements -->
        <button *ngIf="currentPage === 'departement'" (click)="showForm('departement')" class="button">
          Ajouter un Département
        </button>
      
        <!-- Affichage du bouton Ajouter une Cohorte si on est sur la page des cohortes -->
        <button *ngIf="currentPage === 'cohorte'" (click)="showForm('cohorte')" class="button">
          Ajouter une Cohorte
        </button>
    </div>
    
      
      
      
        <div class="filter-right">
          <!-- Barre de recherche avec icône -->
          <div class="search-bar">
            <i class="fas fa-search search-icon"></i> <!-- Icône de loupe de FontAwesome -->
            <input type="text" [(ngModel)]="searchQuery" (input)="filterData()" placeholder="Rechercher..." class="search-input">
          </div>
          
      
          <!-- Afficher le texte du filtre sélectionné -->
          <div class="filter-info">
            <label for="filter-select">Filtre: </label>
            <select id="filter-select" [(ngModel)]="currentPage" (change)="filterType = currentPage; loadData()" class="filter-select">
              <option value="departement">Départements</option>
              <option value="cohorte">Cohortes</option>
            </select>
            
          </div>
          
        </div>
      </div>



      
    
  
    <div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Nombre d'Employés</th>
        <th>Responsable</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
       <!-- Affichez les départements ou les cohortes en fonction du filtre sélectionné -->
       <tr *ngFor="let item of filteredData">
        <td>
          <!-- Conteneur pour la case à cocher et le nom -->
          <div class="name-checkbox-container">
            <input type="checkbox" [(ngModel)]="item.selected" (change)="updateSelectedItems()">
            <span>{{ item.name || item.nom }}</span>
          </div>
        </td>
        <!-- Nombre d'employés ou personnes -->
        <td>{{ item.nombre_personne || item.nombre_personnes }}</td> <!-- Vérifier si c'est un département ou une cohorte -->
        <!-- Responsable -->
        <td>{{ item.responsable_departement || item.responsable_cohorte }}</td> <!-- Vérifier si c'est un département ou une cohorte -->
        <td class="actions">
            <!-- Icône modifier -->
           <!-- Bouton de modification unique -->
<!-- Bouton de modification unique -->
       <!-- Le bouton "Modifier Département" ne s'affiche que si vous êtes sur la page des départements -->
          <button *ngIf="currentPage === 'departement'" (click)="showEditForm('departement', item)" class="action-button">
            <i class="fas fa-edit"></i>
          </button>

          <!-- Le bouton "Modifier Cohorte" ne s'affiche que si vous êtes sur la page des cohortes -->
          <button *ngIf="currentPage === 'cohorte'" (click)="showEditForm('cohorte', item)" class="action-button">
            <i class="fas fa-edit"></i>
          </button>




            
            <!-- Icône supprimer -->
            <button (click)="deleteItem(item)" class="action-button">
              <i class="fas fa-trash-alt"></i> <!-- Icône supprimer -->
            </button>
            <!-- Icône ajouter (pour ajouter un utilisateur) -->
            <button (click)="addItem()" class="action-button">
              <i class="fas fa-plus"></i> <!-- Icône ajouter -->
            </button>
          </td>
      </tr>
    </tbody>
  </table>
</div>



<!-- Formulaire d'ajout de Département -->
<!-- Modal Département -->
<!-- Modal Département -->
<div
  class="modal"
  tabindex="-1"
  [ngClass]="{'show': currentForm === 'departement'}"
  style="display: block;"
  *ngIf="currentForm === 'departement'"
  aria-labelledby="departementModalTitle"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="departementModalTitle">Ajouter un Département</h5>
        <button type="button" class="close" aria-label="Fermer" (click)="closeDepartementForm()">
          <span>&times;</span>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body">

       
        <form (ngSubmit)="addItem()" #departementForm="ngForm">
          <!-- Nom du Département -->
          <div class="form-group mb-3">
            <label for="name" class="form-label">Nom du Département</label>
            <input
              type="text"
              id="name"
              class="form-control"
              name="name"
              [(ngModel)]="newDepartement.name"
              required
              pattern="^[a-zA-Z0-9\s]+$"
              #name="ngModel"
              placeholder="Entrez le nom du département"
              (ngModelChange)="nameValid = name.valid ?? false"
            />
            <div *ngIf="!nameValid && (name.dirty || name.touched)" class="text-danger mt-1">
              <small *ngIf="name?.errors?.['required']">Le nom du département est obligatoire.</small>
              <small *ngIf="name?.errors?.['pattern']">Le nom doit contenir uniquement des lettres, chiffres et espaces.</small>
            </div>

            <div *ngIf="isSubmitted && errorMessage && errorMessage.includes('nom')" class="text-danger mt-1">
              <small>{{ errorMessage }}</small>
            </div>
          </div>

          <!-- Responsable -->
          <div class="form-group mb-3">
            <label for="responsable_departement" class="form-label">Responsable</label>
            <input
              type="text"
              id="responsable_departement"
              class="form-control"
              name="responsable_departement"
              [(ngModel)]="newDepartement.responsable_departement"
              required
              pattern="^[a-zA-Z\s]+$"
              #responsable="ngModel"
              placeholder="Entrez le nom du responsable"
              (ngModelChange)="responsableValid = responsable.valid ?? false"
            />
            <div *ngIf="!responsableValid && (responsable.dirty || responsable.touched)" class="text-danger mt-1">
              <small *ngIf="responsable?.errors?.['required']">Le responsable est obligatoire.</small>
              <small *ngIf="responsable?.errors?.['pattern']">Le responsable doit contenir uniquement des lettres.</small>
            </div>
          </div>

          <!-- Nombre de Personnes -->
          <div class="form-group mb-3">
            <label for="nombre_personne" class="form-label">Nombre de Personnes</label>
            <input
              type="number"
              id="nombre_personne"
              class="form-control"
              name="nombre_personne"
              [(ngModel)]="newDepartement.nombre_personne"
              required
              min="1"
              #nombrePersonne="ngModel"
              placeholder="Entrez le nombre de personnes"
              (ngModelChange)="nombrePersonneValid = nombrePersonne.valid ?? false"
            />
            <div *ngIf="!nombrePersonneValid && (nombrePersonne.dirty || nombrePersonne.touched)" class="text-danger mt-1">
              <small *ngIf="nombrePersonne?.errors?.['required']">Le nombre de personnes est obligatoire.</small>
              <small *ngIf="nombrePersonne?.errors?.['min']">Le nombre de personnes doit être supérieur ou égal à 1.</small>
            </div>
          </div>

          <!-- Description -->
          <div class="form-group mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea
              id="description"
              class="form-control"
              name="description"
              [(ngModel)]="newDepartement.description"
              required
              #description="ngModel"
              placeholder="Décrivez le département"
              (ngModelChange)="descriptionValid = description.valid ?? false"
            ></textarea>
            <div *ngIf="!descriptionValid && (description.dirty || description.touched)" class="text-danger mt-1">
              <small *ngIf="description?.errors?.['required']">La description est obligatoire.</small>
            </div>
          </div>

          <!-- Année -->
          <div class="form-group mb-3">
            <label for="annee" class="form-label">Année</label>
            <input
              type="number"
              id="annee"
              class="form-control"
              name="annee"
              [(ngModel)]="newDepartement.annee"
              required
              min="2000"
              max="2100"
              #annee="ngModel"
              placeholder="Entrez l'année"
              (ngModelChange)="anneeValid = annee.valid ?? false"
            />
            <div *ngIf="!anneeValid && (annee.dirty || annee.touched)" class="text-danger mt-1">
              <small *ngIf="annee?.errors?.['required']">L'année est obligatoire.</small>
              <small *ngIf="annee?.errors?.['min'] || annee?.errors?.['max']">L'année doit être comprise entre 2000 et 2100.</small>
            </div>
          </div>

          <!-- Heure d'entrée -->
          <div class="form-group mb-3">
            <label for="heure_entree" class="form-label">Heure d'entrée</label>
            <input
              type="time"
              id="heure_entree"
              class="form-control"
              name="heure_entree"
              [(ngModel)]="newDepartement.heure_entree"
              required
              #heureEntree="ngModel"
              (ngModelChange)="heureEntreeValid = heureEntree.valid ?? false"
            />
            <div *ngIf="!heureEntreeValid && (heureEntree.dirty || heureEntree.touched)" class="text-danger mt-1">
              <small>L'heure d'entrée est obligatoire.</small>
            </div>
          </div>

          <!-- Heure de sortie -->
          <div class="form-group mb-3">
            <label for="heure_sortie" class="form-label">Heure de sortie</label>
            <input
              type="time"
              id="heure_sortie"
              class="form-control"
              name="heure_sortie"
              [(ngModel)]="newDepartement.heure_sortie"
              required
              #heureSortie="ngModel"
              (ngModelChange)="heureSortieValid = heureSortie.valid ?? false"
            />
            <div *ngIf="!heureSortieValid && (heureSortie.dirty || heureSortie.touched)" class="text-danger mt-1">
              <small>L'heure de sortie est obligatoire.</small>
            </div>
          </div>

          <!-- Bouton Ajouter -->
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="departementForm.invalid"
          >
            Ajouter Département
          </button>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Modal de Cohorte -->
<div class="modal" tabindex="-1" [ngClass]="{'show': currentForm === 'cohorte'}" style="display: block;" *ngIf="currentForm === 'cohorte'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter une Cohorte</h5>
        <button type="button" class="close" (click)="closeCohorteForm()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">

       
        <form (ngSubmit)="addItem()" #cohorteForm="ngForm">
          <!-- Nom de la Cohorte -->
          <div class="form-group mb-3">
            <label for="nom" class="form-label">Nom de la Cohorte</label>
            <input
              type="text"
              id="nom"
              class="form-control"
              name="nom"
              [(ngModel)]="newCohorte.nom"
              required
              pattern="^[a-zA-Z0-9\s]+$"
              #nom="ngModel"
              placeholder="Entrez le nom de la cohorte"
              (ngModelChange)="nomValid = nom.valid ?? false"
            />
            
            <!-- Erreurs de validation du nom -->
            <div *ngIf="!nomValid && (nom.dirty || nom.touched)" class="text-danger mt-1">
              <small *ngIf="nom?.errors?.['required']">Le nom de la cohorte est obligatoire.</small>
              <small *ngIf="nom?.errors?.['pattern']">Le nom doit contenir uniquement des lettres, chiffres et espaces.</small>
            </div>
          
            <!-- Erreur du serveur si le nom existe déjà -->
            <div *ngIf="isSubmitted && errorMessage && errorMessage.includes('nom')" class="text-danger mt-1">
              <small>{{ errorMessage }}</small>
            </div>
          </div>
          

          <!-- Responsable -->
          <div class="form-group mb-3">
            <label for="responsable_cohorte" class="form-label">Responsable</label>
            <input
              type="text"
              id="responsable_cohorte"
              class="form-control"
              name="responsable_cohorte"
              [(ngModel)]="newCohorte.responsable_cohorte"
              required
              pattern="^[a-zA-Z\s]+$"
              #responsable="ngModel"
              placeholder="Entrez le nom du responsable"
              (ngModelChange)="responsableValid = responsable.valid ?? false"
            />
            <div *ngIf="!responsableValid && (responsable.dirty || responsable.touched)" class="text-danger mt-1">
              <small *ngIf="responsable?.errors?.['required']">Le responsable est obligatoire.</small>
              <small *ngIf="responsable?.errors?.['pattern']">Le responsable doit contenir uniquement des lettres.</small>
            </div>
          </div>

          <!-- Nombre de Personnes -->
          <div class="form-group mb-3">
            <label for="nombre_personnes" class="form-label">Nombre de Personnes</label>
            <input
              type="number"
              id="nombre_personnes"
              class="form-control"
              name="nombre_personnes"
              [(ngModel)]="newCohorte.nombre_personnes"
              required
              min="1"
              #nombrePersonnes="ngModel"
              placeholder="Entrez le nombre de personnes"
              (ngModelChange)="nombrePersonnesValid = nombrePersonnes.valid ?? false"
            />
            <div *ngIf="!nombrePersonnesValid && (nombrePersonnes.dirty || nombrePersonnes.touched)" class="text-danger mt-1">
              <small *ngIf="nombrePersonnes?.errors?.['required']">Le nombre de personnes est obligatoire.</small>
              <small *ngIf="nombrePersonnes?.errors?.['min']">Le nombre de personnes doit être supérieur ou égal à 1.</small>
            </div>
          </div>

          <!-- Description -->
          <div class="form-group mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea
              id="description"
              class="form-control"
              name="description"
              [(ngModel)]="newCohorte.description"
              required
              #description="ngModel"
              placeholder="Décrivez la cohorte"
              (ngModelChange)="descriptionValid = description.valid ?? false"
            ></textarea>
            <div *ngIf="!descriptionValid && (description.dirty || description.touched)" class="text-danger mt-1">
              <small *ngIf="description?.errors?.['required']">La description est obligatoire.</small>
            </div>
          </div>

          <!-- Date de début -->
          <div class="form-group mb-3">
            <label for="date_debut" class="form-label">Date de début</label>
            <input
              type="date"
              id="date_debut"
              class="form-control"
              name="date_debut"
              [(ngModel)]="newCohorte.date_debut"
              required
              #dateDebut="ngModel"
              (ngModelChange)="dateDebutValid = dateDebut.valid ?? false"
            />
            <div *ngIf="!dateDebutValid && (dateDebut.dirty || dateDebut.touched)" class="text-danger mt-1">
              <small>L'année de début est obligatoire.</small>
            </div>
          </div>

          <!-- Date de fin -->
          <div class="form-group mb-3">
            <label for="date_fin" class="form-label">Date de fin</label>
            <input
              type="date"
              id="date_fin"
              class="form-control"
              name="date_fin"
              [(ngModel)]="newCohorte.date_fin"
              required
              #dateFin="ngModel"
              (ngModelChange)="dateFinValid = dateFin.valid ?? false"
            />
            <div *ngIf="!dateFinValid && (dateFin.dirty || dateFin.touched)" class="text-danger mt-1">
              <small>La date de fin est obligatoire.</small>
            </div>
          </div>

          <!-- Heure d'entrée -->
          <div class="form-group mb-3">
            <label for="heure_entree" class="form-label">Heure d'entrée</label>
            <input
              type="time"
              id="heure_entree"
              class="form-control"
              name="heure_entree"
              [(ngModel)]="newCohorte.heure_entree"
              required
              #heureEntree="ngModel"
              (ngModelChange)="heureEntreeValid = heureEntree.valid ?? false"
            />
            <div *ngIf="!heureEntreeValid && (heureEntree.dirty || heureEntree.touched)" class="text-danger mt-1">
              <small>L'heure d'entrée est obligatoire.</small>
            </div>
          </div>

          <!-- Heure de sortie.main-container {
    display: flex;
    height: 100vh;
    background-color: #f9f9f9;
  } -->
          <div class="form-group mb-3">
            <label for="heure_sortie" class="form-label">Heure de sortie</label>
            <input
              type="time"
              id="heure_sortie"
              class="form-control"
              name="heure_sortie"
              [(ngModel)]="newCohorte.heure_sortie"
              required
              #heureSortie="ngModel"
              (ngModelChange)="heureSortieValid = heureSortie.valid ?? false"
            />
            <div *ngIf="!heureSortieValid && (heureSortie.dirty || heureSortie.touched)" class="text-danger mt-1">
              <small>L'heure de sortie est obligatoire.</small>
            </div>
          </div>

          <!-- Bouton Ajouter -->
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="cohorteForm.invalid"
          >
            Ajouter Cohorte
          </button>
        </form>
      </div>
    </div>
  </div>
</div>






<!-- Modal de Modification de Département -->
<div class="modal" tabindex="-1" [ngClass]="{'show': currentEditForm === 'departement'}" *ngIf="currentEditForm === 'departement'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier le Département</h5>
        <button type="button" class="close" (click)="closeDepartementForm()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateDepartement()" #departementForm="ngForm">
          <div class="form-group">
            <label for="name">Nom du Département</label>
            <input type="text" id="name" [(ngModel)]="currentDepartement.name" name="name" required class="form-control">
          </div>
          <div class="form-group">
            <label for="responsable_departement">Responsable</label>
            <input type="text" id="responsable_departement" [(ngModel)]="currentDepartement.responsable_departement" name="responsable_departement" required class="form-control">
          </div>
          <div class="form-group">
            <label for="nombre_personne">Nombre de Personnes</label>
            <input type="number" id="nombre_personne" [(ngModel)]="currentDepartement.nombre_personne" name="nombre_personne" required class="form-control">
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" [(ngModel)]="currentDepartement.description" name="description" class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label for="annee">Année</label>
            <input type="number" id="annee" [(ngModel)]="currentDepartement.annee" name="annee" required class="form-control">
          </div>

          <div class="form-group">
            <label for="heure_entree">Heure d'entrée</label>
            <input type="time" id="heure_entree" [(ngModel)]="currentDepartement.heure_entree" name="heure_entree" required class="form-control">
          </div>

          <div class="form-group">
            <label for="heure_sortie">Heure de sortie</label>
            <input type="time" id="heure_sortie" [(ngModel)]="currentDepartement.heure_sortie" name="heure_sortie" required class="form-control">
          </div>

          <!-- Bouton pour afficher les employés associés -->
          <button type="button" class="btn btn-info" (click)="getEmployes(currentDepartement.id)">Employés Associés</button>

          <button type="submit" class="btn btn-primary">Enregistrer les Modifications</button>
        </form>

        <!-- Liste des employés associés -->
        <div *ngIf="employesAssocies.length > 0" class="mt-3">
          <h5>Employés Associés :</h5>
          <ul class="list-group">
            <li *ngFor="let employe of employesAssocies" class="list-group-item d-flex justify-content-between">
              <span>{{ employe.nom }} {{ employe.prenom }}</span>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- Modal de Modification de Cohorte -->
<div class="modal" tabindex="-1" [ngClass]="{'show': currentEditForm === 'cohorte'}" *ngIf="currentEditForm === 'cohorte'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier la Cohorte</h5>
        <button type="button" class="close" (click)="closeCohorteForm()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateCohorte()" #cohorteForm="ngForm">
          <div class="form-group">
            <label for="nom">Nom de la Cohorte</label>
            <input type="text" id="nom" [(ngModel)]="currentCohorte.nom" name="nom" required class="form-control">
          </div>
          <div class="form-group">
            <label for="responsable_cohorte">Responsable</label>
            <input type="text" id="responsable_cohorte" [(ngModel)]="currentCohorte.responsable_cohorte" name="responsable_cohorte" required class="form-control">
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" [(ngModel)]="currentCohorte.description" name="description" class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label for="date_debut">Date de début</label>
            <input type="date" id="date_debut" [(ngModel)]="currentCohorte.date_debut" name="date_debut" required class="form-control">
          </div>

          <div class="form-group">
            <label for="date_fin">Date de fin</label>
            <input type="date" id="date_fin" [(ngModel)]="currentCohorte.date_fin" name="date_fin" required class="form-control">
          </div>

          <div class="form-group">
            <label for="heure_entree">Heure d'entrée</label>
            <input type="time" id="heure_entree" [(ngModel)]="currentCohorte.heure_entree" name="heure_entree" required class="form-control">
          </div>

          <div class="form-group">
            <label for="heure_sortie">Heure de sortie</label>
            <input type="time" id="heure_sortie" [(ngModel)]="currentCohorte.heure_sortie" name="heure_sortie" required class="form-control">
          </div>

          <button type="button" class="btn btn-info" (click)=" getApprenantsAssocies(currentCohorte.id)">Employés Associés</button>
          <button type="submit" class="btn btn-primary">Enregistrer les Modifications</button>

            <!-- Liste des apprenants associés -->
        <div *ngIf="apprenantsAssocies.length > 0" class="mt-3">
          <h5>Apprenants Associés :</h5>
          <ul class="list-group">
            <li *ngFor="let apprenant of apprenantsAssocies" class="list-group-item d-flex justify-content-between">
              <span>{{ apprenant.nom }} {{ apprenant.prenom }}</span>
            </li>
          </ul>
        </div>

        </form>
      </div>
    </div>
  </div>
</div>


<!-- Modal de Succès -->
<div class="modal" tabindex="-1" [ngClass]="{'show': showSuccessModal}" style="display: block;" *ngIf="showSuccessModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Succès</h5>
        <button type="button" class="close" (click)="closeSuccessModal()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>La cohorte a été ajoutée avec succès!</p>
      </div>
    </div>
  </div>
</div>



<!-- Pagination -->
<div class="pagination">
  <button (click)="prevPage()" class="pagination-button">Précédent</button>
  <span>Page {{ currentPages }}</span>
  <button (click)="nextPage()" class="pagination-button">Suivant</button>
</div>

<!-- Bouton Supprimer les éléments sélectionnés -->
<button (click)="deleteSelected()" *ngIf="selectedItems.length > 0" class="delete-button">
  <i class="fas fa-trash-alt"></i> Supprimer Sélectionnés
</button>